---
title: "Taller SECEM"
author: "Javier Fernández-López"
date: "28 de noviembre de 2023"
bibliography: references_tutorials.bib
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
 
 
 Tutoriales para el taller **Introducción a la modelización jerárquica: detectabilidad imperfecta en modelos de ocupación y N-mixture** impartido en el XVI Congreso de la SECEM (6-9 de diciembre de 2023 en Granollers).
 
# Modelos de ocupación

Vamos a modelizar la ocupación (probabilidad de presencia) de una especie a partir de datos de cámaras trampa. Nuestro área de estudio es una zona montañosa dividida en una malla de 50x50 celdas. Sabemos que nuestra especie utiliza mayormente el hábitat de matorral de los fondos de valle de nuestro área de estudio. Disponemos de un total de 100 cámaras de fototrampeo que hemos dispuesto aleatoriamente en nuestro área de estudio que han estado activas durante 7 noches utilizando una lata de sardinas como atrayente. De las 100 cámaras, 47 de ellas son de la marca A y 53 de la marca B.


```{r ch1, message=F, cache = F, eval = F}
# Instalamos y cargamos las librerías que vamos a utilizar
#install.packages("terra")
library(terra)
library(unmarked)
library(AICcmodavg)


datos <- read.csv("https://raw.githubusercontent.com/jabiologo/web/master/tutorials/tallerSECEM_files/occuDatos.csv")
head(datos)
```

```{r ch2, message=FALSE, cache = F, eval = F}
elev <- rast("https://github.com/jabiologo/web/raw/master/tutorials/tallerSECEM_files/elev.tif")
arbu <- rast("https://github.com/jabiologo/web/raw/master/tutorials/tallerSECEM_files/arbu.tif")
names(elev) <- "elev"
names(arbu) <- "arbu"
par(mfrow = c(1,2))
plot(elev, main = "Elevación")
points(xyFromCell(elev, datos$id[datos$marca == "A"]), col = "darkred", pch = 19)
points(xyFromCell(elev, datos$id[datos$marca == "B"]), col = "darkblue", pch = 19)
plot(arbu, main = "Porcentaje arbusto")
datos$elev <- scale(elev[datos$id])[1:100]
datos$arbu <- scale(arbu[datos$id])[1:100]
head(datos)
```

```{r ch3, message=FALSE, cache = T, echo = T, eval = F}
obserCov <- list(dia = as.matrix(datos[,10:16]))
datosUM <- unmarkedFrameOccu(as.matrix(datos[,3:9]), siteCovs=datos[,c(2,17,18)], obsCovs=obserCov)
#m1 <- occu(~ marca  + dia ~ elev + arbu, data = datosUM)
m2 <- occu(~ marca  + dia + arbu ~ elev + arbu, data = datosUM)
#m3 <- occu(~ marca  + dia + arbu + elev ~ elev + arbu, data = datosUM)


plotEffects(m2, type = "det", covariate="arbu")

# scaled = (x-mean(x))/sd
elevScaled <- (elev - 958.29) / 187.6693
arbuScaled <- (arbu - 49.78) / 7.041493

dataPred <- c(elevScaled, arbuScaled)
names(dataPred) <- c("elev", "arbu")

pred <- predict(m2, dataPred, type = "state")
plot(pred)

mb.gof.test(m2, nsim = 50)
```

# Modelos N-mixture

Vamos a modelizar la abundancia (número de individuos) de una especie a partir de conteos realizados en muestreos repetidos. Nuestro área de estudio es una zona de transición agrícola-forestal en una malla de 50x50 celdas. Sabemos que nuestra especie habita principalmente en bosques y tiene querencia por temperaturas cálidas. Hemos muestreado un total de 100 sitios diferentes en los que hemos realizado conteos directos. Como sabemos que nuestra especie es sensible a la temperatura, en cada muestreo tomamos nota de la temperatura que había en ese momento.

```{r ch4, message=FALSE, cache = T, echo = T, eval = T}

datos <- read.csv("https://github.com/jabiologo/web/raw/master/tutorials/tallerSECEM_files/nmixDatos.csv")
head(datos)

cober <- rast("https://github.com/jabiologo/web/raw/master/tutorials/tallerSECEM_files/cober.tif")
tempe <- rast("https://github.com/jabiologo/web/raw/master/tutorials/tallerSECEM_files/tempe.tif")
names(cober) <- "cober"
names(tempe) <- "tempe"
par(mfrow = c(1,2))
plot(tempe, main = "Temperatura")
points(xyFromCell(tempe, datos$id), pch = 19, cex = 0.5)
plot(cober, main = "Cobertura del suelo")
datos$tempe <- scale(tempe[datos$id])[1:100]
datos$cober <- as.factor(cober[datos$id][,1])
head(datos)

obserCov <- list(tOc = datos[,5:7])
datosUM <- unmarkedFramePCount(y = as.matrix(datos[,2:4]), siteCovs=datos[,8:9], obsCovs=obserCov)
m1 <- pcount(~ tOc ~ tempe + cober, data = datosUM)
m1

plotEffects(m1, type = "det", covariate="tOc")
plotEffects(m1, type = "state", covariate="cober")

# scaled = (x-mean(x))/sd
tempeScaled <- (tempe[] - 26.22) / 5.02

dataPred <- data.frame(cbind(tempeScaled, cober[]))
names(dataPred) <- c("tempe", "cober")
dataPred$cober <- as.factor(dataPred$cober)


pred <- predict(m1, dataPred, type = "state")

predRas <- rast(nrows=50, ncols=50, xmin=0, xmax=50, ymin = 0, ymax = 50)
predRas[] <- pred$Predicted
plot(predRas)

#Nmix.gof.test(m1, nsim = 50)

```


