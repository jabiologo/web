---
title: "N-mixture models"
author: "Javier Fernández-López"
date: "22 de mayo de 2020"
bibliography: references_tutorials.bib
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

La abundancia de una especie es un parámetro clave para conocer el estado de cualquier población y poder realizar una correcta gestión de la misma. Sin embargo, conocer el número total de individuos que componenen una población, $N$, no es tarea sencilla. Para aproximarnos a ese número se pueden diseñar muestreos que nos permitan obtener un índice de abundancia de la población, $I$. De forma general, se podría considerar que
$$N = k * I$$
donde $N$ sería el número total de individuos de una población, $I$ el índice de abundancia (el conteo de individuos que hayamos obtenido durante unos muestreos, por ejemplo) y la $k$ sería la detectabilidad o capturabilidad, la eficiencia que tenemos para detectar individuos durante los muestreos. Conocer esta $k$ nos permitiría estimar la abundancia total de individuos $N$, pero a menudo es complicada de obtener. Algunas aproximaciones como la captura-marcaje-recaptura se basan en la identificación individual de los individuos para realizar estimas de esta detectabilidad y poder así estimar abundancias absolutas (XXXX), pero esta metodología suele ser costosa de implementar. 

Los N-mixture models, modelos de mezclas o modelo de conteos [@Royle2004] nos permiten estimar la abundancia de una especie a partir de muestreos repetidos. Estos modelos estiman a la vez la abundancia y la probabilidad de detección/capturabilidad de la especie estudiada a partir de conteos repetidos $t$ ocasiones en $n$ sitios diferentes.

En el siguiente tutorial se pretende comprender las generalidades de los N-mixture models a partir de una serie de simulaciones utilizando el lenguaje R y el paquete _unmarked_ (XXXXX)

# N-mixture models: Generalidades

Pongamos que salimos al campo a buscar individuos de ciervo _(Cervus elaphus)_. De forma general podemos afirmar que si detectamos un individuo significa que la especie está presente en ese lugar. Sin embargo, el hecho de no detectarla puede estar indicándonos dos cosas:

1.   Que la especie no esté presente en ese lugar porque el hábitat no es el adecuado.
2.   Que la especie esté presente pero no hayamos sido capaces de detectarla.

Para tener en cuenta estas dos opciones, los N-mixture models constan de dos procesos:

* Un proceso (o modelo) que determina la abundancia real de la especie.
* Un proceso (o modelo) que determina la probabilidad de detección de la especie.

A continuación simularemos una serie de situaciones a modo de ejemplo para entender un poco mejor ambos procesos.

# Simulación del área de estudio y del muestreo SIN covariables

Con ayuda de R, vamos a simular una población de ciervos que se distribuye en un área de 100 km<sup>2</sup> (100 cuadrados de 1 km de lado)

```{r studyarea, message=FALSE}
set.seed(1) # ajustamos una "semilla"" para controlar la repetibilidad 
library(raster)
sarea <- raster(nrows = 10, ncols = 10, xmn = 0, xmx = 10, ymn = 0, ymx = 10)

```

Este área de momento está vacía, por lo que tendremos que llenarla de ciervos virtuales. Podemos utilizar una [distribución de Poisson](https://www.youtube.com/watch?v=BbLfV0wOeyc) para "esparcir" nuestros ciervos simulados en el área de estudio. Esta distrubución es una de las más comunmente utilizadas en el estudio de abundancias. Esta distribución maneja la frecuencia con la que un evento ocurre en un intervalo específico. Consta de un único parámetro llamado lambda $\lambda$ que determina el número de eventos que ocurren normalmente en ese intervalo. 
  
    
```{r poisson, echo = FALSE, fig.height = 4, fig.width = 9, fig.align = "center"}
par(mfrow=c(1,2))
hist(rpois(10000,4), main = "Poisson lambda = 4", xlab = "nº de veces que ocurre el evento", ylab = "frecuencia", breaks = 10)
hist(rpois(10000,8), main = "Poisson lambda = 8", xlab = "nº de veces que ocurre el evento", ylab = "frecuencia", breaks = 20)
```
  
  
En nuestro caso, el número de ciervos virtuales que colocaremos en cada cuadrícula de 1x1 km vendrá determinado por una distribución de Poisson con $\lambda = 4$:

$$N_{i} \sim Poisson(\lambda)$$
siendo $N_{i}$ el número total de individuos en la celda $i$.

Como podemos ver en el histograma de la izquierda, los valores más probables serán 3 o 4 ciervos, aunque variarán entre cero y 14 aproximadamente (aunque este útimo valor será muy poco probable).

```{r ciervos,fig.height = 5.8, fig.width = 6, fig.align = "center"}
# Seleccionamos el lambda deseado
lambda <- 4

# Generamos 100 números aleatorios obtenidos de una distribucion
# de Poisson con una lambda = 4
sarea[] <- rpois(100, lambda)  

# Graficamos nuestro área de estudio
plot(sarea)
```

Si hacemos la suma de todas las celdas de nuestro área de estudio, podremos saber el número total de individuos que hemos simulado ($N$):

```{r Ntotal}
# Calculamos el número total de ciervos virtuales creados (N)
sum(sarea[])
```

A continuación tenemos que simular nuestro muestreo. Éste consistirá en 15 cuadrículas aleatorias de nuestro área de estudio a las cuales realizaremos 4 visitas en cada una (ocasiones). Durante los muestreos intentaremos detectar el máximo número posible de ciervos, pero desgraciadamente sabemos que tenemos una probabilidad de detección del 40% de media para todo nuestro área de estudio. Esto significa que, en general, seremos capaces de detectar menos de la mitad de ciervos en cada muestreo. Para modelizar esta detectabilidad podemos utilizar una [distribución binomial](https://www.youtube.com/watch?v=_FbZI9mtSSM). La distribución binomial maneja la probabilidad de éxito para un número de sucesos con dos resultados posibles: éxito o fracaso (cara o cruz, par o impar, etc.). Pongamos que una celda tiene 10 ciervos. La detección de cada uno de esos 10 ciervos puede verse como 10 sucesos en los que puedo tener éxito (detecto al ciervo) o fracasar (el ciervo está, pero no lo detecto). De esta forma, tendríamos que

$$y_{i,k} \sim binomial(N_{i}, p)$$

dónde $y_{i,k}$ es el número de individuos detectados en la celda $i$ en la visita/ocasión $k$, $N_{i}$ es el número de individuos en la celda $i$ y $p$ es la probabilidad de detectar cada ciervo, siendo en nuestro caso $p = 0.4$. Recapitulando, muestrearemos 15 cuadrículas aleatorias durante 4 visitas diferentes. En cada visita tendremos una probabilidad media de ver el 40% de los ciervos que se encuentren en la cuadrícula. El siguiente código simula este proceso:

```{r muestreo}
# Seleccionamos 15 celdas aleatorias de nuestro area de estudio
site_ID <- sample(1:100, 15)
dataset <- data.frame(site_ID)

# Vamos a almacenar en número real de individuos de cada celda para poder hacer 
# comparaciones posteriormente
dataset$trueN <- extract(sarea,site_ID)

# Iniciamos nuestras 4 visitas
dataset$O1 <- NA
dataset$O2 <- NA
dataset$O3 <- NA
dataset$O4 <- NA

# Con un doble bucle, visitarremos 4 veces cada uno de nuestras 15 cuadrículas
for (j in 1:4){
  for (i in 1:length(site_ID)){
    # Nótese que los individuos detectados vienen determinados por una 
    # binomial con probabilidad 0.4, véase help(rbinom)
    dataset[i,j+2] <- rbinom(1, extract(sarea,site_ID[i]), 0.4)
  }
}

```

Una vez realizado el muestreo, veamos el resultado del mismo. Primero graficamos nuestro área de estudio con las celdas muestreadas:

```{r area_muestreos,fig.height = 5.8, fig.width = 6, fig.align = "center"}
plot(sarea)
points(xyFromCell(sarea,site_ID), pch = 4, cex = 1.5)
```

Ahora, vamos a explorar el resultado de nuestros muestreos en cada una de las visitas:

```{r dataset}
dataset
```

La primera columna (site_ID) es un identificador de la cuadrícula. La segunda (trueN) indica el número real de individuos que se encuentran en cada cuadrícula de nuestro muestreo. Las 4 columnas siguientes (O1,O2... O4) indican el número de ciervos detectados en cada una de nuestras visitas/ocasiones. Como habíamos predicho, al tener un 40% de detectabilidad, casi siempre detectamos menos de la mitad de ciervos de los que realmente hay.

En el mundo real, el problema surge al no conocer esa detectabilidad. Al realizar los distintos muestreos no sabemos realmente cuál es el procentaje de individios que somos capaces de detectar. Una primera estima sería quedarnos con el valor máximo de cada una de nuestras visitas para cada uno de los 15 muestreos. Asumiendo que la población en cada celda es cerrada (sin migración, nacimientos o muerte de individuos) el numero máximo de individuos detectados en cada una de las 4 visitas podría ser un buen punto de partida para aproximar una abundancia total. Lo calculamos y lo comparamos con el número real del siguiente modo:

```{r nmax,fig.height = 5.8, fig.width = 6, fig.align = "center"}
# Calculamos los individuos máximos detectados por visita
dataset$maxN <- apply(dataset[,3:6],1, max)

# Graficamos la relación con los individuos reales
plot(dataset$trueN, dataset$maxN, xlim = c(0,7.5), ylim = c(0,7.5), 
     xlab = "número real de individuos", ylab = "número detectado de individuos")
abline(0,1)
```

Como veníamos intuyendo, infraestimamos el número real de ciervos. De hecho, como sabemos que tenemos un 40% de eficacia de detección, podríamos adelantar que, de media, seguramente estaremos detectando aproximadamente un 40% de ciervos de los que hay en realidad. Vamos a comprobarlo:

```{r nmean}
# Calculamos la media de individuos vistos en las 4 visitas
dataset$meanN <- apply(dataset[,3:6],1, mean)

#Sumamos las medias de los 15 sitios y lo comparamos con los valores reales
sum(dataset$meanN) / sum(dataset$trueN)
```

Efectivamente, de media estamos viendo un 39% de los individuos que realmente hay. Para poder ajustar un modelo que fuese capaz de calcular el número total de individuos, deberíamos primero ser capaces de calcular esa detectabilidad, esto es, el parámetro $p$ de la distribución binomial.

# Modelo N-mixture sencillo en _unmarked_

Como ya hemos dicho, los N-mixture models nos permiten modelizar a la vez la probabilidad de detección y la abundancia de nuestra especie a partir de muestreos repetidos. Para ajustar este tipo de modelos utilizadremos la función `pcount` del paquete _unmarked_ (XXXX). En primer lugar, debemos preparar los datos para que _unmarked_ pueda leerlos. Utilizaremos la función `unmarkedFramePCount` para indicar cuales son los 15 muestreos repetidos en 4 ocasiones

```{r unmarkedFramePCount, message=FALSE}
library(unmarked)
dataUM <- unmarkedFramePCount(y = dataset[,3:6])

# Echamos un vistazo al objeto dataUM
head(dataUM)
```

Ahora podremos ajustar nuestro modelo con la función `pcount`. Vamos a ajustar el modelo más sencillo. En este ejemplo, ni la abundancia ni la propabilidad de detección vienen determinados por ninguna variable, simplemente responden a un proceso de Poisson con $\lambda = 4$ y a una distribución binomial con $p = 4$ respectivamente. Lo que intentaremos averiguar con este modelo son esos dos parámetros.

```{r m1}
# Como en este modelo no hay variables predictoras, las fórmulas de detectabilidad
# y de abundancia las dejamos como ~1. Más información en help(pcount)
m1 <- pcount(~1 ~1, data=dataUM, K=50)
summary(m1)
```

La función nos devuelve las estimaciones de los parámetros $\lambda$ y $p$ transformados en log y logit respectivamente. Es decir, el modelo realmente ajusta el parámetro $log(\lambda)$ y $logit(p)$, por lo que a estas estimas hay que hacerles la transformación inversa:

```{r backtransform}
# lambda estimada:
exp(coef(m1)[1]) # log

# p estimada:
#exp(coef(m1)[2])/(1+exp(coef(m1)[2])) # log ratio o log odds = logit
plogis(coef(m1)[2]) # log ratio o log odds = logit; igual que arriba

```

Como vemos, la estima de $\lambda$ es de 4.64 frente a la real, que era de 4. Por otro lado, la estima de $p$ es de 0.35, mientras que la $p$ real o detectabilidad era de 0.4. No es un modelo perfecto, pero se ajusta bastante a la realidad. ¿Cómo podríamos mejorar estas estimas? Incrementando el número de sitios muestreados, aumentando el número de visitas en cada sitio, etc. En cualquier caso, podemos calcular las abundancias predichas por nuestro modelo para cada sitio visitado y ver cómo se ajusta con respecto a la abundancia real. Para ello, usaremos la función `bup`:

```{r pred_m1, fig.height = 5.8, fig.width = 6, fig.align = "center"}
# Calculamos las predicciones de abundancias
N_m1<- bup(ranef(m1)) 

# graficamos la relación entre las abundancias reales y las predichas
plot(dataset$trueN,N_m1, xlab="True density", ylab="Predicted density")
abline(0,1)# a 1:1 line

```

Vemos ahora que hemos solventado el problema de la infraestima. Este modelo tan sencillo sirve para explicar de forma clara el funcionamiento del modelo N-mixture binomial. Sin embargo, la abundancia normalmente suele venir determinada por alguna covariable predictora que afecta a la distribución de las especies, como disponibilidad de recursos, refugio, etc. Por eso, a continuación simularemos otro set de datos y ajustatemos un modelo algo más complejo.


# Simulación del área de estudio y del muestreo CON covariables

Supongamos ahora que nuestra población de ciervos virtuales se distribuye en un paisaje como el de la siguiente imagen
<br/><br/> 
![](nmixture_files/images/dwat.png)
<br/><br/>    
   
Como vemos, hay un punto de agua en la parte inferior izquierda. Vamos a crear una capa raster que indique la distancia al punto de agua, la cual usaremos posteriormente como variable predictora para distribuir nuestros ciervos.

```{r dwat_create, fig.height = 5.8, fig.width = 6, fig.align = "center"}
# Nótese que estamos estandarizando las distancias con scale(). 
# Para no obtener distancias negativas, le sumaremos 2.28668
dwat <- scale(distanceFromPoints(sarea, c(3.5,3.5))) + 2.28668

plot(dwat)
```

En el ejemplo anterior, habíamos distribuido los ciervos aleatoriamente siguiendo una distribución de Poisson con $\lambda = 4$ para todo el territorio. 

$$N \sim Poisson(\lambda)$$

Sin embargo, ahora queremos que nuestros ciervos se distribuyan conforme a la distancia al punto de agua, de tal forma que haya más ciervos cerca del agua, y su abundancia disminuya conforme nos vamos alejando de ella. Eso quiere decir que $\lambda$ debe ser mayor en valores bajos de distancia al agua $dwat$, e irá disminuyendo con forme aumente $dwat$. Este comportamiento se puede expresar como

$$ log(\lambda_{i}) = \beta_{0} + \beta_{1} * dwat_{i} $$
donde $\lambda_{i}$ es la abundancia promedio en la celda $i$, $\beta_{0}$ es el intercepto del modelo lineal que predice la abundancia, $\beta_{1}$ es la fuerza del efecto de la distancia al agua sobre la abundancia de ciervos, y $dwat_{i}$ es la distancia al punto de agua desde la celda $i$. Así, podemos intuir que la $\lambda$de cada celda dependerá de la variable "distancia al agua". Por lo tanto, la ecuación general que gobernará la distribución de nuestros ciervos ahora sera:

$$N \sim Poisson(exp(\beta_{0} + \beta_{1} * dwat))$$

Para que se cumpla nuestra premisa de que haya menos ciervos cuanto más nos alejemos del punto de agua, al coeficiente $\beta_{1}$ deberemos darle un valor negativo. Estos serán nuestros valores:

*   $\beta_{0} = 3$
*   $\beta_{1} = -0.9$

Calculamos la $\lambda$ para cada celda siguiendo nuestra fórmula y los valores elegidos para los coeficientes

```{r lambda, fig.height = 5.8, fig.width = 6, fig.align = "center"}
beta_0 <- 3
beta_1 <- -0.9

lambda <- exp(beta_0 + beta_1*(dwat))
plot(lambda)
```

Una vez tenemos el $\lambda$ de cada celda, solo nos queda "rellenar" nuestro área de estudio siguiendo, como en el ejemplo anterior, una distribución de Poisson. Sin embargo esta vez, en vez de utilizar $\lambda = 4$ para todo el territorio, usaremos el $\lambda$ calculado específicamente para cada celda en función de la distancia al punto de agua:

```{r Nlambda, fig.height = 5.8, fig.width = 6, fig.align = "center"}
# Creamos un raster de 10x10 celdas vacías
sarea <- raster(nrows = 10, ncols = 10, xmn = 0, xmx = 10, ymn = 0, ymx = 10)  # study area

# Usamos un bucle para rellenar cada celda con el número de ciervos correspondiente según
# el lambda de cada celda
for (i in 1:ncell(sarea)){
  sarea[i] <- rpois(1, lambda[i])
}

# Graficamos la distribución de nuestros ciervos virtuales
plot(sarea)
```


Ya tenemos nuestros ciervos distribuidos. Recapitulando, esta población también se distribuye siguiendo una distribución de Poisson. La diferencia con respecto al ejemplo anterior es que ahora el parámentro $\lambda$ de esa distribución no es homogéneo para todo el área de estudio, sino que varía con respecto a una covariable o variable predictora, la distancia a un punto de agua en nuestro caso. Esta situación es mucho más realista que la anterior.

Para comprobar la relación entre la abundancia de ciervos y la distancia al agua, podemos graficar la correlación entre número de individuos en cada celda y la distancia de estas al punto de agua:

``` {r corr, fig.height = 5.8, fig.width = 6, fig.align = "center"}
plot(dwat[],sarea[], xlab = "distancia al punto de agua", ylab = "nº de ciervos")

```

Vayamos ahora a simular el muestreo. Como en el ejemplo anterior, éste consistirá en 15 cuadrículas aleatorias de nuestro área de estudio a las cuales realizaremos 4 visitas en cada una (ocasiones). Sin embargo ahora, nuestra probabilidad de detección de los animales también va a venir definido por la distancia al agua. Como vimos en la foto aérea de nuestro paisaje, cerca del agua encontramos una mayor vegetación, lo cual dificulta la detección de nuestros ciervos, ya que se pueden ocultar mejor. Por lo tanto puestra capacidad de detección disminuirá conforme nos acerquemos al agua. Como ya habíamos visto anteriormentem el proceso de observación venía definido por la fórmula

$$y_{i,k} \sim binomial(N_{i}, p)$$
siendo la probabilidad de detectar un ciervo $p$ un parámetro constante en todo nuestro área de estudio ($p = 0.4$). Sin embargo ahora, ese parámetro $p$ va a variar con respecto a nuestra covariable predictora de la siguiente manera:

$$logit(p)= \gamma_{0} + \gamma_{1} * dwat$$
donde de forma similar al modelo de $\lambda$, ahora $\gamma_{0}$ y $\gamma_{1}$ son respectivamente el intercepto y la fuerza con la que la distancia al agua afecta a la probabilidad de detección de los ciervos. Pongamos que los valores son los siguientes:

*   $\gamma_{0} = 0.2$
*   $\gamma_{1} = 0.8$

Fijémnos que $\gamma_{1}$ es positivo. Esto querrá decir que "a mayor distancia del punto de agua, mayor probabilidad de detectar un ciervo". Vamos a calcular ahora ese parámetro $p$ para todo nuestro área de estudio al igual que hicimos con $\lambda$.


```{r sample_cov, fig.height = 5.8, fig.width = 6, fig.align = "center"}

# logit(p) = gamma_0 + gamma_1 * (dwat)
gamma_0 <- 0.2
gamma_1 <- 0.8

# Para despejar logit() de la izquierda, pasamos a la derecha todo este cociente
p <- exp(gamma_0 + gamma_1 * dwat) / (1 + exp(gamma_0 + gamma_1 * dwat))

# Graficamos la probabilidad de detección/observación
plot(p)
```


Como vemos, la probabilidad de detección lejos del punto de agua llega casi al 100%. Sin embargo, cerca del punto de agua esta detectabilidad desciente hasta el 50% aproximadamente. Podemos graficar la relación entre distancia al punto de agua y la probabilidad de detección:

``` {r relacion, fig.height = 5.8, fig.width = 6, fig.align = "center"}
plot(dwat[], p[], xlab = "distancia al punto de agua", ylab = "detectabilidad", ylim = c(0.4,1))

```

A continuación podemos simular nuestros 15 puntos aleatorios de muestreo. Al igual que en el ejemplo anterior, visitaremos 4 veces cada punto, y aplicaremos la detectabilidad $p$ correspondiente a cada celda.

``` {r sample_covar}
site_ID <- sample(1:100, 15)

plot(sarea)
points(xyFromCell(sarea,site_ID), pch = 4, cex = 1.5)

dataset <- data.frame(site_ID)
dataset$trueN <- extract(sarea,site_ID)
dataset$O1 <- NA
dataset$O2 <- NA
dataset$O3 <- NA
dataset$O4 <- NA

for (j in 1:4){
  for (i in 1:length(site_ID)){
    # Nótese que utilizamos rbinom() con p = al obtenido del raster "p"
    dataset[i,j+2] <- rbinom(1, extract(sarea,site_ID[i]), extract(p,site_ID[i]))
  }
}

dataset

```

Una vez obtenido nuestro conteo de ciervos, necesitamos obtener los valores de nuestra variable predictora para cada uno de los puntos de muestreo:

``` {r sample_dwat}

dataset$dwat <- extract(dwat, site_ID)

```

Finalmente, debemos agrupar todos estos datos en un objeto entendible por el paquete _unmarked_ como ya hicimos en el ejemplo anterior utilizando la función _unmarkedFramePCount()_

``` {r unmarkeddataframe}
dataUM <- unmarkedFramePCount(y = dataset[,3:6], siteCovs=data.frame(dwat=dataset$dwat))

```

Ahora estamos listos para ajustar un segundo modelo en el que tengamos en cuenta nuestra covariable predictora. En este caso, tanto el modelo de abundancia como el de detectabilidad van a estar determinados por la misma covariable, la distancia al punto de agua $dwat$, así que utilizaremos la función _pcount_ de este modo:

``` {r pcount_covariable}


# Tanto el proceso de detección como el de abundancia dependen de dwat, por tanto
# utilizaremos ~dwat ~dwat en la fórmula. 
m2 <- pcount(~dwat ~dwat, data=dataUM, K=150)

```
