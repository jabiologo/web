---
title: "N-mixture models"
author: "Javier Fernández-López"
date: "22 de mayo de 2020"
bibliography: references_tutorials.bib
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

La abundancia de una especie es un parámetro clave para conocer el estado de cualquier población y poder realizar una correcta gestión de la misma. Sin embargo, conocer el número total de individuos que componenen una población, $N$, no es tarea sencilla. Para aproximarnos a ese número se pueden diseñar muestreos que nos permitan obtener un índice de abundancia de la población, $I$. De forma general, se podría considerar que
$$N = k * I$$
donde $N$ sería el número total de individuos de una población, $I$ el índice de abundancia (el conteo de individuos que hayamos obtenido durante unos muestreos, por ejemplo) y la $k$ sería la detectabilidad o capturabilidad, la eficiencia que tenemos para detectar individuos durante los muestreos. Conocer esta $k$ nos permitiría estimar la abundancia total de individuos $N$, pero a menudo es complicada de obtener. Algunas aproximaciones como la captura-marcaje-recaptura se basan en la identificación individual de los individuos para realizar estimas de esta detectabilidad y poder así estimar abundancias absolutas (XXXX), pero esta metodología suele ser costosa de implementar. 

Los N-mixture models, modelos de mezclas o modelo de conteos [@Royle2004] nos permiten estimar la abundancia de una especie a partir de muestreos repetidos. Estos modelos estiman a la vez la abundancia y la probabilidad de detección/capturabilidad de la especie estudiada a partir de conteos repetidos $t$ ocasiones en $n$ sitios diferentes.

En el siguiente tutorial se pretende comprender las generalidades de los N-mixture models a partir de una serie de simulaciones utilizando el lenguaje R y el paquete _unmarked_ (XXXXX)

# N-mixture models: Generalidades

Pongamos que salimos al campo a buscar individuos de ciervo _(Cervus elaphus)_. De forma general podemos afirmar que si detectamos un individuo significa que la especie está presente en ese lugar. Sin embargo, el hecho de no detectarla puede estar indicándonos dos cosas:

1.   Que la especie no esté presente en ese lugar porque el hábitat no es el adecuado.
2.   Que la especie esté presente pero no hayamos sido capaces de detectarla.

Para tener en cuenta estas dos opciones, los N-mixture models constan de dos procesos:

* Un proceso (o modelo) que determina la abundancia real de la especie.
* Un proceso (o modelo) que determina la probabilidad de detección de la especie.

A continuación simularemos una serie de situaciones a modo de ejemplo para entender un poco mejor ambos procesos.

# Simulación del área de estudio y del muestreo

Con ayuda de R, vamos a simular una población de ciervos que se distribuye en un área de 100 km<sup>2</sup> (100 cuadrados de 1 km de lado)

```{r studyarea, message=FALSE}
set.seed(1) # ajustamos una "semilla"" para controlar la repetibilidad 
library(raster)
sarea <- raster(nrows = 10, ncols = 10, xmn = 0, xmx = 10, ymn = 0, ymx = 10)

```

Este área de momento está vacía, por lo que tendremos que llenarla de ciervos virtuales. Podemos utilizar una [distribución de Poisson](https://www.youtube.com/watch?v=BbLfV0wOeyc) para "esparcir" nuestros ciervos simulados en el área de estudio. Esta distrubución es una de las más comunmente utilizadas en el estudio de abundancias. Esta distribución maneja la frecuencia con la que un evento ocurre en un intervalo específico. Consta de un único parámetro llamado lambda $\lambda$ que determina el número de eventos que ocurren normalmente en ese intervalo. 
  
    
```{r poisson, echo = FALSE, fig.height = 3, fig.width = 3, fig.align = "center"}
par(mfrow=c(1,2))
hist(rpois(10000,4), main = "Poisson lambda = 4", xlab = "nº de veces que ocurre el evento", ylab = "frecuencia", breaks = 10)
hist(rpois(10000,8), main = "Poisson lambda = 8", xlab = "nº de veces que ocurre el evento", ylab = "frecuencia", breaks = 20)
```
  
  
En nuestro caso, el número de ciervos virtuales que colocaremos en cada cuadrícula de 1x1 km vendrá determinado por una distribución de Poisson con $\lambda = 4$:

$$N_{i} \sim Poisson(\lambda)$$
siendo $N_{i}$ el número total de individuos en la celda $i$.

Como podemos ver en el histograma de la izquierda, los valores más probables serán 3 o 4 ciervos, aunque variarán entre cero y 14 aproximadamente (aunque este útimo valor será muy poco probable).

```{r ciervos}
# Seleccionamos el lambda deseado
lambda <- 4

# Generamos 100 números aleatorios obtenidos de una distribucion
# de Poisson con una lambda = 4
sarea[] <- rpois(100, lambda)  

# Graficamos nuestro área de estudio
plot(sarea)
```

Si hacemos la suma de todas las celdas de nuestro área de estudio, podremos saber el número total de individuos que hemos simulado ($N$):

```{r Ntotal}
# Calculamos el número total de ciervos virtuales creados (N)
sum(sarea[])
```

A continuación tenemos que simular nuestro muestreo. Éste consistirá en 15 cuadrículas aleatorias de nuestro área de estudio a las cuales realizaremos 4 visitas en cada una (ocasiones). Durante los muestreos intentaremos detectar el máximo número posible de ciervos, pero desgraciadamente sabemos que tenemos una probabilidad de detección del 40% de media para todo nuestro área de estudio. Esto significa que, en general, seremos capaces de detectar menos de la mitad de ciervos en cada muestreo. Para modelizar esta detectabilidad podemos utilizar una [distribución binomial](https://www.youtube.com/watch?v=_FbZI9mtSSM). La distribución binomial maneja la probabilidad de éxito para un número de sucesos con dos resultados posibles: éxito o fracaso (cara o cruz, par o impar, etc.). Pongamos que una celda tiene 10 ciervos. La detección de cada uno de esos 10 ciervos puede verse como 10 sucesos en los que puedo tener éxito (detecto al ciervo) o fracasar (el ciervo está, pero no lo detecto). De esta forma, tendríamos que

$$y_{i,k} \sim binomial(N_{i}, p)$$

dónde $y_{i,k}$ es el número de individuos detectados en la celda $i$ en la visita/ocasión $k$, $N_{i}$ es el número de individuos en la celda $i$ y $p$ es la probabilidad de detectar cada ciervo, siendo en nuestro caso $p = 0.4$. Recapitulando, muestrearemos 15 cuadrículas aleatorias durante 4 visitas diferentes. En cada visita tendremos una probabilidad media de ver el 40% de los ciervos que se encuentren en la cuadrícula. El siguiente código simula este proceso:

```{r muestreo}
# Seleccionamos 15 celdas aleatorias de nuestro area de estudio
site_ID <- sample(1:100, 15)
dataset <- data.frame(site_ID)

# Vamos a almacenar en número real de individuos de cada celda para poder hacer 
# comparaciones posteriormente
dataset$trueN <- extract(sarea,site_ID)

# Iniciamos nuestras 4 visitas
dataset$O1 <- NA
dataset$O2 <- NA
dataset$O3 <- NA
dataset$O4 <- NA

# Con un doble bucle, visitarremos 4 veces cada uno de nuestras 15 cuadrículas
for (j in 1:4){
  for (i in 1:length(site_ID)){
    # Nótese que los individuos detectados vienen determinados por una 
    # binomial con probabilidad 0.4, véase help(rbinom)
    dataset[i,j+2] <- rbinom(1, extract(sarea,site_ID[i]), 0.4)
  }
}

```

Una vez realizado el muestreo, veamos el resultado del mismo. Primero graficamos nuestro área de estudio con las celdas muestreadas:

```{r area_muestreos}
plot(sarea)
points(xyFromCell(sarea,site_ID), pch = 4, cex = 1.5)
```

Ahora, vamos a explorar el resultado de nuestros muestreos en cada una de las visitas:

```{r dataset}
dataset
```

La primera columna (site_ID) es un identificador de la cuadrícula. La segunda (trueN) indica el número real de individuos que se encuentran en cada cuadrícula de nuestro muestreo. Las 4 columnas siguientes (O1,O2... O4) indican el número de ciervos detectados en cada una de nuestras visitas/ocasiones. Como habíamos predicho, al tener un 40% de detectabilidad, casi siempre detectamos menos de la mitad de ciervos de los que realmente hay.

En el mundo real, el problema surge al no conocer esa detectabilidad. Al realizar los distintos muestreos no sabemos realmente cuál es el procentaje de individios que somos capaces de detectar. Una primera estima sería quedarnos con el valor máximo de cada una de nuestras visitas para cada uno de los 15 muestreos. Asumiendo que la población en cada celda es cerrada (sin migración, nacimientos o muerte de individuos) el numero máximo de individuos detectados en cada una de las 4 visitas podría ser un buen punto de partida para aproximar una abundancia total. Lo calculamos y lo comparamos con el número real del siguiente modo:

```{r nmax}
# Calculamos los individuos máximos detectados por visita
dataset$maxN <- apply(dataset[,3:6],1, max)

# Graficamos la relación con los individuos reales
plot(dataset$trueN, dataset$maxN, xlab = "número real de individuos", ylab = "número detectado de individuos")
abline(0,1)
```

Como veníamos intuyendo, infraestimamos el número real de ciervos. De hecho, como sabemos que tenemos un 40% de eficacia de detección, podríamos adelantar que, de media, seguramente estaremos detectando aproximadamente un 40% de ciervos de los que hay en realidad. Vamos a comprobarlo:

```{r nmean}
# Calculamos la media de individuos vistos en las 4 visitas
dataset$meanN <- apply(dataset[,3:6],1, mean)

#Sumamos las medias de los 15 sitios y lo comparamos con los valores reales
sum(dataset$meanN) / sum(dataset$trueN)


```

Efectivamente, de media estamos viendo un 39% de los individuos que realmente hay. Para poder ajustar un modelo que fuese capaz de calcular el número total de individuos, deberíamos primero ser capaces de calcular esa detectabilidad, esto es, el parámetro $p$ de la distribución binomial.

# Ajuste de un modelo N-mixture con _unmarked_

